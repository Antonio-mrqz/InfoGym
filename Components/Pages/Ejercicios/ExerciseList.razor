@page "/exercises"
@using MudBlazorWebApp1.Models
@using MudBlazorWebApp1.Services
@using MudBlazorWebApp1.Pages
@inject IExerciseService ExerciseService
@inject IDialogService DialogService

<style>
    .hover-card {
    transition: all 0.3s ease;
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    background-color: #222222;
    border: 1px solid #222222; /* Borde del mismo color que el fondo */
    }

    .hover-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 10px 20px rgba(217, 4, 41, 0.3);
    border: 1px solid rgba(217, 4, 41, 0.5); /* Borde rojo en hover */
    }

    .fondo-difuminado {
    backdrop-filter: blur(10px);
    }

    .mud-pagination-item {
        list-style: none !important;
    }
</style>

@* TITULO Y SEPARADOR *@
<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mb-4 text-center">
    <div style="display: flex; align-items: center; justify-content: center;">
        <MudIcon Icon="@Icons.Material.Filled.FitnessCenter" Style="font-size: 3rem; margin-right: 0.5rem;" />
        <MudText Typo="Typo.h2"
                 Class="font-weight-bold"
                 Style="display: flex; align-items: center; font-family: 'Oswald', sans-serif; font-size: 3rem;">
            Ejercicios
        </MudText>
    </div>
    <MudDivider Class="mt-2 mx-auto" Style="height: 3px; background-color: #D90429; width: 100px;" />
</MudContainer>


@* CONTENIDO *@
<MudContainer Class="mt-16">

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
    }

    <MudGrid>
        @if (isLoading)
        {
            <MudItem xs="12" Class="d-flex justify-center">
                <MudProgressCircular Color="Color.Primary" Style="height:70px;width:70px;" Indeterminate="true" />
            </MudItem>
        }
        else if (pagedExercises == null || !pagedExercises.Any())
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Info">No se encontraron ejercicios. Por favor verifica la conexión a la API.</MudAlert>
            </MudItem>
        }
        else
        {
            @foreach (var exercise in pagedExercises)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Style="height: 100%;" Class="hover-card">
                        <MudCardMedia Image="@exercise.GifUrl" Height="200" />
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-family: 'Oswald', sans-serif; font-weight: 700;">@exercise.Name</MudText>
                            <MudText Typo="Typo.body2">Parte del cuerpo: @exercise.BodyPart</MudText>
                            <MudText Typo="Typo.body2">Músculo objetivo: @exercise.Target</MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Text"
                            Color="Color.Primary"
                            OnClick="() => OpenExerciseDialog(exercise)">
                                Ver instrucciones
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }

        }
    </MudGrid>
    <!-- Paginación -->
    @if (!isLoading)
    {
        <MudPagination ShowFirstButton="true" ShowLastButton="true"
                       Count="totalPages"
                       Selected="@currentPage"
                       SelectedChanged="ChangePage"
                       Class="mt-4 d-flex justify-center" />
    }

</MudContainer>

@code {
    private List<Exercise>? exercises;
    private List<Exercise>? pagedExercises;
    private Exercise? selectedExercise;
    private bool dialogVisible;
    private bool isLoading = true;
    private string errorMessage = "";

    private int currentPage = 1;
    private int itemsPerPage = 8; // Número de ejercicios por página
    private int totalPages => (exercises?.Count ?? 0 + itemsPerPage - 1) / itemsPerPage;

    [Inject] private NavigationManager Navigation { get; set; }

    // Funcion para poder ir a la página anterior
    private void GoBack()
    {
        Navigation.NavigateTo("/", forceLoad: true);
    }

    // Funcion que carga los ejercicios de la API al cargarse la página
    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            exercises = await ExerciseService.GetExercisesAsync();

            if (exercises == null || !exercises.Any())
            {
                errorMessage = "No se pudieron cargar los ejercicios. Verifica la conexión a la API.";
            }
            else
            {
                UpdatePagedExercises();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar los ejercicios: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ChangePage(int page)
    {
        currentPage = page;
        UpdatePagedExercises();
    }

    private void UpdatePagedExercises()
    {
        if (exercises == null) return;
        int startIndex = (currentPage - 1) * itemsPerPage;
        pagedExercises = exercises.Skip(startIndex).Take(itemsPerPage).ToList();
    }
    private async Task OpenExerciseDialog(Exercise exercise)
    {
        var parameters = new DialogParameters<ExerciseInstructionsDialog>
        {
            { x => x.Exercise, exercise }
        };

        var options = new DialogOptions
            {
                FullWidth = true,
                MaxWidth = MaxWidth.Medium,
                BackgroundClass = "fondo-difuminado"
            };

        DialogService.Show<ExerciseInstructionsDialog>("Instrucciones del ejercicio", parameters, options);
    }
}